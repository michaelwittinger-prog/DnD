{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/schemas/mir_types.schema.json",
  "title": "MIR Shared Type Definitions",
  "description": "Reusable type definitions referenced by mir_gamestate.schema.json.",
  "$defs": {
    "entityId": {
      "type": "string",
      "minLength": 1,
      "description": "Unique identifier for any entity."
    },
    "position": {
      "type": "object",
      "additionalProperties": false,
      "required": ["x", "y"],
      "properties": {
        "x": { "type": "integer", "minimum": 0 },
        "y": { "type": "integer", "minimum": 0 },
        "facing": {
          "enum": ["N", "E", "S", "W", null],
          "default": null,
          "description": "Optional facing direction (4-way). Null means no facing tracked."
        }
      }
    },
    "entityKind": {
      "enum": ["player", "npc", "object"],
      "description": "Discriminator for entity type."
    },
    "entitySize": {
      "enum": ["S", "M", "L"],
      "description": "Token footprint size. S=small, M=medium (1 cell), L=large (2x2)."
    },
    "controllerType": {
      "enum": ["human", "ai"],
      "description": "Who controls this entity."
    },
    "tokenStyle": {
      "enum": ["standee", "mini", "pawn"],
      "description": "Physical token representation."
    },
    "combatMode": {
      "enum": ["exploration", "combat"],
      "description": "Current game phase."
    },
    "rngMode": {
      "enum": ["manual", "seeded"],
      "description": "How dice rolls are resolved."
    },
    "roll": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "timestamp", "formula", "resultTotal"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "timestamp": { "type": "string", "format": "date-time" },
        "formula": {
          "type": "string",
          "minLength": 1,
          "description": "Dice formula, e.g. '1d20+5', '2d6'."
        },
        "resultTotal": { "type": "integer" },
        "breakdown": {
          "type": "string",
          "description": "Optional human-readable breakdown, e.g. '[14]+5=19'."
        },
        "source": {
          "type": "string",
          "description": "Optional label for what this roll was for, e.g. 'Seren initiative'."
        }
      }
    },
    "terrainTile": {
      "type": "object",
      "additionalProperties": false,
      "required": ["x", "y", "type", "blocksMovement"],
      "properties": {
        "x": { "type": "integer", "minimum": 0 },
        "y": { "type": "integer", "minimum": 0 },
        "type": {
          "type": "string",
          "minLength": 1,
          "description": "Terrain classification, e.g. 'open', 'blocked', 'difficult', 'water', 'pit'."
        },
        "blocksMovement": { "type": "boolean" },
        "blocksVision": {
          "type": "boolean",
          "description": "Optional. Whether this tile blocks line of sight."
        }
      }
    },
    "inventoryItem": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "qty", "tags"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "name": { "type": "string", "minLength": 1 },
        "qty": { "type": "integer", "minimum": 1 },
        "tags": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        }
      }
    },
    "logEvent": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "timestamp", "type", "payload"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "timestamp": { "type": "string", "format": "date-time" },
        "type": { "type": "string", "minLength": 1 },
        "payload": {
          "type": "object",
          "description": "Event-specific data. JSON serializable, structure varies by type."
        }
      }
    },
    "entity": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "kind",
        "name",
        "position",
        "size",
        "stats",
        "conditions",
        "inventory",
        "token",
        "controller"
      ],
      "properties": {
        "id": { "$ref": "#/$defs/entityId" },
        "kind": { "$ref": "#/$defs/entityKind" },
        "name": { "type": "string", "minLength": 1 },
        "position": { "$ref": "#/$defs/position" },
        "size": { "$ref": "#/$defs/entitySize" },
        "stats": {
          "type": "object",
          "additionalProperties": false,
          "required": ["hpCurrent", "hpMax", "ac", "movementSpeed"],
          "properties": {
            "hpCurrent": { "type": "integer", "minimum": 0 },
            "hpMax": { "type": "integer", "minimum": 1 },
            "ac": { "type": "integer", "minimum": 0 },
            "movementSpeed": {
              "type": "integer",
              "minimum": 0,
              "description": "Movement in cells per turn."
            }
          }
        },
        "conditions": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Free-form condition strings. Each must be non-empty."
        },
        "conditionDurations": {
          "type": "object",
          "additionalProperties": { "type": "integer", "minimum": 0 },
          "description": "Tracks remaining rounds for timed conditions. Keys are condition names, values are rounds remaining."
        },
        "inventory": {
          "type": "array",
          "items": { "$ref": "#/$defs/inventoryItem" }
        },
        "token": {
          "type": "object",
          "additionalProperties": false,
          "required": ["style", "spriteKey"],
          "properties": {
            "style": { "$ref": "#/$defs/tokenStyle" },
            "spriteKey": {
              "type": ["string", "null"],
              "description": "Sprite asset reference. Null for unstyled tokens."
            }
          }
        },
        "controller": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "playerId"],
          "properties": {
            "type": { "$ref": "#/$defs/controllerType" },
            "playerId": {
              "type": ["string", "null"],
              "description": "Human player id. Null for AI-controlled entities."
            }
          }
        }
      }
    }
  }
}
